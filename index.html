<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLRunner</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css"
        id="hljs-light">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"
        id="hljs-dark" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <script>
        // Suppress highlight.js security warnings
        window.hljs.configure({
            ignoreUnescapedHTML: true
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #181d21 0%, #1b2e35 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-run {
            background-color: #2196F3;
            color: white;
        }

        .btn-clear {
            background-color: #f44336;
            color: white;
        }

        .btn-reset {
            background-color: #607D8B;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: none;
            box-shadow: none;
        }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
            background-color: white;
            margin: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e0e0e0;
        }

        .editor-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: #757575;
            border-right: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .tab.active {
            color: #2196F3;
            background: white;
            font-weight: 500;
        }

        .editor-container {
            position: relative;
            height: 100%;
            overflow: hidden;
            background: #fff;
        }

        .dark-mode .editor-container {
            background: #2d2d2d;
        }

        .editor-wrapper {
            position: relative;
            height: 100%;
            overflow: auto;
            padding-left: 50px;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            min-height: 100%;
            width: 40px;
            padding: 10px 5px;
            text-align: right;
            color: #999;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
            user-select: none;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            pointer-events: none;
        }

        .dark-mode .line-numbers {
            background: #252526;
            color: #858585;
            border-right-color: #444;
        }

        .editor {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 10px;
            margin: 0;
            border: none;
            outline: none;
            resize: none;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
            tab-size: 2;
            white-space: pre;
            background: transparent;
            color: #333;
            overflow: auto;
        }

        .dark-mode .editor {
            color: #e0e0e0;
            background: #1e1e1e;
        }

        .active-line {
            background: rgba(33, 150, 243, 0.1);
        }

        .bracket-match {
            background: rgba(33, 150, 243, 0.3);
            border-radius: 2px;
        }

        .output-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .output-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .output-content {
            flex: 1;
            overflow: auto;
            background: white;
        }

        .preview {
            height: 100%;
            width: 100%;
            border: none;
            background: white;
            display: none;
        }

        .preview.active {
            display: block;
        }

        .console {
            height: 100%;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-y: auto;
            background: white;
            color: #212121;
            display: none;
        }

        .console.active {
            display: block;
        }

        .console-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .console-log {
            color: #212121;
        }

        .console-error {
            color: #d32f2f;
            background: #ffebee;
            padding: 8px;
            border-left: 3px solid #d32f2f;
            margin: 4px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: block;
        }

        .console-warn {
            color: #f57c00;
            background: #fff3e0;
            padding: 8px;
            border-left: 3px solid #ff9800;
            margin: 4px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: block;
        }

        .console-info {
            color: #0288d1;
        }

        .timestamp {
            color: #757575;
            font-size: 11px;
            margin-right: 8px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            border: 4px solid rgba(33, 150, 243, 0.2);
            border-radius: 50%;
            border-top: 4px solid #2196F3;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .console-object {
            cursor: pointer;
            color: #795548;
            font-style: italic;
        }

        .console-object:before {
            content: '▶ ';
            font-size: 10px;
            display: inline-block;
            transition: transform 0.2s;
        }

        .console-object.expanded:before {
            transform: rotate(90deg);
        }

        .console-object-content {
            display: none;
            margin-left: 20px;
            border-left: 1px solid #e0e0e0;
            padding-left: 10px;
        }

        .console-object.expanded+.console-object-content {
            display: block;
        }

        @media (max-width: 768px) {
            .main {
                flex-direction: column;
            }

            .editor-panel,
            .output-panel {
                width: 100%;
                height: 50%;
            }

            .editor-tabs,
            .output-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .tab {
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .controls {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .btn {
                padding: 6px 10px;
                font-size: 0.8em;
            }

            .logo {
                font-size: 1em;
            }
        }

        .error-message {
            background: #ffebee;
            color: #d32f2f;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #d32f2f;
            display: none;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        /* Dark mode gradient */
        .dark-mode .header {
            background: linear-gradient(135deg, #181d21 0%, #1b2e35 100%);
        }

        .dark-mode .logo {
            background: linear-gradient(135deg, #64b5f6, #80d8ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dark-mode .container {
            background: #1a1a1a;
        }

        .dark-mode .main,
        .dark-mode .editor-panel,
        .dark-mode .output-panel,
        .dark-mode .editor,
        .dark-mode .preview,
        .dark-mode .console {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }

        .dark-mode .editor-tabs,
        .dark-mode .output-tabs {
            background: #333;
            border-bottom-color: #444;
        }

        .dark-mode .tab {
            color: #aaa;
            border-right-color: #444;
        }

        .dark-mode .tab.active {
            background: linear-gradient(135deg, #1e262c 0%, #23363e 100%);
            color: #fff;
        }

        .dark-mode .console {
            color: #e0e0e0;
        }

        .dark-mode .console-error {
            background: #3e2723;
            border-left-color: #d32f2f;
        }

        .dark-mode .console-warn {
            background: #3e2c00;
            border-left-color: #ff9800;
        }

        .dark-mode .console-info {
            color: #4fc3f7;
        }

        .dark-mode .console-object {
            color: #9cdcfe;
        }

        .dark-mode .console-object-content {
            border-left-color: #444;
        }

        .dark-mode .timestamp {
            color: #888;
        }

        /* Theme toggle button */
        .theme-toggle {
            background: none;
            border: 2px solid #1A5E97;
            color: #1A5E97;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .dark-mode .theme-toggle {
            border-color: #64b5f6;
            color: #64b5f6;
        }

        .theme-toggle:hover {
            background: rgba(33, 150, 243, 0.1);
        }

        .dark-mode .theme-toggle:hover {
            background: rgba(100, 181, 246, 0.1);
        }

        .theme-toggle i {
            font-size: 16px;
        }

        /* Dark mode styles for console text */
        .dark-mode .console-log {
            color: #9cdcfe;
        }

        .dark-mode .console-warn {
            color: #dcdcaa;
        }

        .dark-mode .console-error {
            color: #f48771;
        }

        .dark-mode .console-info {
            color: #4fc3f7;
        }

        .dark-mode .console-debug {
            color: #c586c0;
        }

        /* Highlight.js overrides for dark mode */
        .dark-mode .hljs {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        .dark-mode .hljs-keyword,
        .dark-mode .hljs-selector-tag,
        .dark-mode .hljs-literal,
        .dark-mode .hljs-section,
        .dark-mode .hljs-link {
            color: #569cd6;
        }

        .dark-mode .hljs-string,
        .dark-mode .hljs-title,
        .dark-mode .hljs-name,
        .dark-mode .hljs-attribute,
        .dark-mode .hljs-symbol,
        .dark-mode .hljs-bullet,
        .dark-mode .hljs-addition,
        .dark-mode .hljs-variable,
        .dark-mode .hljs-template-tag,
        .dark-mode .hljs-template-variable {
            color: #ce9178;
        }

        .dark-mode .hljs-comment,
        .dark-mode .hljs-quote,
        .dark-mode .hljs-deletion,
        .dark-mode .hljs-meta {
            color: #6a9955;
        }

        .dark-mode .hljs-keyword,
        .dark-mode .hljs-selector-tag,
        .dark-mode .hljs-literal,
        .dark-mode .hljs-doctag,
        .dark-mode .hljs-title,
        .dark-mode .hljs-section,
        .dark-mode .hljs-type,
        .dark-mode .hljs-selector-id {
            font-weight: bold;
        }

        /* Make sure the theme toggle works with highlight.js */
        .dark-mode #hljs-light {
            display: none;
        }

        .dark-mode #hljs-dark {
            display: block;
        }

        #hljs-dark {
            display: none;
        }
    </style>
</head>

<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="error-message" id="error-message"></div>

    <div class="container">
        <div class="header">
            <div class="logo">HTMLRunner</div>
            <div class="controls">
                <button class="btn btn-run" onclick="runCode()">▶ Run</button>
                <button class="btn btn-clear" onclick="clearConsole()">Clear Console</button>
                <button class="btn btn-reset" onclick="resetCode()">Reset</button>
                <button class="theme-toggle" onclick="toggleDarkMode()">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
            </div>
        </div>

        <div class="main">
            <div class="editor-panel">
                <div class="editor-tabs">
                    <div class="tab active" data-tab="html" onclick="switchTab('html')">HTML</div>
                    <div class="tab" data-tab="css" onclick="switchTab('css')">CSS</div>
                    <div class="tab" data-tab="js" onclick="switchTab('js')">JavaScript</div>
                </div>

                <div class="editor-container">
                    <div class="editor-wrapper">
                        <div class="line-numbers" id="line-numbers"></div>
                        <pre id="html-editor" class="editor" contenteditable="true" spellcheck="false"></pre>
                    </div>
                </div>

                <div class="editor-container" style="display: none;">
                    <div class="editor-wrapper">
                        <div class="line-numbers" id="css-line-numbers"></div>
                        <pre id="css-editor" class="editor" contenteditable="true" spellcheck="false"></pre>
                    </div>
                </div>

                <div class="editor-container" style="display: none;">
                    <div class="editor-wrapper">
                        <div class="line-numbers" id="js-line-numbers"></div>
                        <pre id="js-editor" class="editor" contenteditable="true" spellcheck="false"></pre>
                    </div>
                </div>
            </div>

            <div class="output-panel">
                <div class="output-tabs">
                    <div class="tab active" data-output="preview" onclick="switchOutput('preview')">Preview</div>
                    <div class="tab" data-output="console" onclick="switchOutput('console')">Console</div>
                </div>

                <div class="output-content">
                    <iframe id="preview" class="preview active"></iframe>
                    <div id="console" class="console"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'html';
        let currentOutput = 'preview';
        let consoleOutput = document.getElementById('console');
        let isDarkMode = false;

        const state = {
            html: '',
            css: '',
            js: '',
            activeTab: 'html',
            activeOutput: 'preview'
        };

        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');

        document.addEventListener('DOMContentLoaded', function () {
            loadState();
            runCode();
            // Only call initializeEditors once
            initializeEditors();
            document.querySelectorAll('.editor').forEach(editor => {
                editor.addEventListener('input', debounce(saveState, 500));
            });

            // Load dark mode preference
            isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                updateThemeIcon();
            }

            // Initialize highlight.js
            hljs.highlightAll();
        });

        window.addEventListener('message', function (event) {
            if (event.data.type === 'console') {
                const entry = document.createElement('div');
                entry.className = 'console-entry';

                const timestamp = document.createElement('span');
                timestamp.className = 'timestamp';
                timestamp.textContent = new Date().toLocaleTimeString();

                const message = document.createElement('span');
                message.className = `console-${event.data.level}`;

                if (event.data.data && event.data.data.length > 0) {
                    event.data.data.forEach((item, i) => {
                        if (i > 0) message.appendChild(document.createTextNode(' '));

                        if (item && typeof item === 'object') {
                            message.appendChild(renderObject(item));
                        } else {
                            const text = String(item);
                            message.appendChild(document.createTextNode(text));
                        }
                    });
                }

                entry.appendChild(timestamp);
                entry.appendChild(document.createTextNode(' '));
                entry.appendChild(message);
                consoleOutput.appendChild(entry);
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        });

        function renderObject(obj, level = 0) {
            if (obj === null) {
                return document.createTextNode('null');
            }

            if (typeof obj !== 'object') {
                return document.createTextNode(String(obj));
            }

            if (Array.isArray(obj)) {
                return renderArray(obj, level);
            }

            const container = document.createElement('span');

            if (obj instanceof Error) {
                const errorEl = document.createElement('span');
                errorEl.className = 'console-error';
                errorEl.textContent = `${obj.name}: ${obj.message}`;
                if (obj.stack) {
                    errorEl.textContent += `\n${obj.stack.split('\n').slice(1).join('\n')}`;
                }
                container.appendChild(errorEl);
                return container;
            }

            const preview = document.createElement('span');
            preview.className = 'console-object';
            preview.textContent = Array.isArray(obj) ? `Array(${obj.length})` : '{...}';

            const content = document.createElement('div');
            content.className = 'console-object-content';

            Object.entries(obj).forEach(([key, value]) => {
                const prop = document.createElement('div');
                prop.textContent = `${key}: `;

                if (value && typeof value === 'object') {
                    prop.appendChild(renderObject(value, level + 1));
                } else {
                    prop.appendChild(document.createTextNode(
                        typeof value === 'string' ? `"${value}"` : String(value)
                    ));
                }

                content.appendChild(prop);
            });

            preview.addEventListener('click', (e) => {
                e.stopPropagation();
                preview.classList.toggle('expanded');
            });

            container.appendChild(preview);
            container.appendChild(content);
            return container;
        }

        function renderArray(arr, level) {
            const container = document.createElement('span');
            const preview = document.createElement('span');
            preview.className = 'console-object';
            preview.textContent = `Array(${arr.length})`;

            const content = document.createElement('div');
            content.className = 'console-object-content';

            arr.forEach((item, i) => {
                const el = document.createElement('div');
                el.textContent = `${i}: `;

                if (item && typeof item === 'object') {
                    el.appendChild(renderObject(item, level + 1));
                } else {
                    el.appendChild(document.createTextNode(
                        typeof item === 'string' ? `"${item}"` : String(item)
                    ));
                }

                content.appendChild(el);
            });

            preview.addEventListener('click', (e) => {
                e.stopPropagation();
                preview.classList.toggle('expanded');
            });

            container.appendChild(preview);
            container.appendChild(content);
            return container;
        }

        function getEditorText(editor) {
            // Use textContent to preserve newlines exactly
            return editor.textContent.replace(/\u200B/g, '');
        }

        function setEditorText(editor, text) {
            // Use textContent to preserve newlines exactly
            const normalizedText = text.replace(/\r\n/g, '\n');
            editor.textContent = normalizedText;
            // Force a line number update
            const lineNumbersId = editor.id === 'html-editor' ? 'line-numbers' :
                                (editor.id === 'css-editor' ? 'css-line-numbers' : 'js-line-numbers');
            updateLineNumbers(editor.id, document.getElementById(lineNumbersId));
        }

        function saveState() {
            state.html = getEditorText(document.getElementById('html-editor'));
            state.css = getEditorText(document.getElementById('css-editor'));
            state.js = getEditorText(document.getElementById('js-editor'));
            state.activeTab = document.querySelector('.editor-tabs .tab.active').dataset.tab;
            state.activeOutput = document.querySelector('.output-tabs .tab.active').dataset.output;

            try {
                localStorage.setItem('htmlRunnerState', JSON.stringify(state));
            } catch (e) {
                showError('Failed to save state: ' + e.message);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('htmlRunnerState');
                if (savedState) {
                    const parsed = JSON.parse(savedState);

                    if (parsed.html) setEditorText(document.getElementById('html-editor'), parsed.html);
                    if (parsed.css) setEditorText(document.getElementById('css-editor'), parsed.css);
                    if (parsed.js) setEditorText(document.getElementById('js-editor'), parsed.js);

                    if (parsed.activeTab) {
                        const tab = document.querySelector(`.editor-tabs .tab[data-tab="${parsed.activeTab}"]`);
                        if (tab) tab.click();
                    }

                    if (parsed.activeOutput) {
                        const output = document.querySelector(`.output-tabs .tab[data-output="${parsed.activeOutput}"]`);
                        if (output) output.click();
                    }

                    // Update line numbers and highlighting after loading state
                    initializeEditors();
                }
            } catch (e) {
                showError('Failed to load saved state: ' + e.message);
            }
        }

        function showLoading() {
            loadingEl.classList.add('active');
        }

        function hideLoading() {
            loadingEl.classList.remove('active');
        }

        function showError(message) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function runCode() {
            showLoading();
            clearConsole();

            try {
                const html = getEditorText(document.getElementById('html-editor'));
                const css = getEditorText(document.getElementById('css-editor'));
                const js = getEditorText(document.getElementById('js-editor'));

                // Pre-parse JS to catch syntax errors before running in iframe
                try {
                    if (js.trim()) {
                        new Function(js);
                    }
                } catch (syntaxError) {
                    const entry = document.createElement('div');
                    entry.className = 'console-entry';
                    const timestamp = document.createElement('span');
                    timestamp.className = 'timestamp';
                    timestamp.textContent = new Date().toLocaleTimeString();
                    const message = document.createElement('span');
                    message.className = 'console-error';
                    message.textContent = `SyntaxError: ${syntaxError.message}`;
                    entry.appendChild(timestamp);
                    entry.appendChild(document.createTextNode(' '));
                    entry.appendChild(message);
                    consoleOutput.appendChild(entry);
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                    hideLoading();
                    return;
                }

                let preview = document.getElementById('preview');
                const newFrame = document.createElement('iframe');
                newFrame.id = 'preview';
                newFrame.className = 'preview' + (preview.classList.contains('active') ? ' active' : '');
                newFrame.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-modals allow-popups allow-forms');
                preview.parentNode.replaceChild(newFrame, preview);
                preview = newFrame;

                // Console interceptor script
                const consoleInterceptor = `\nconst originalConsole = {\n    log: console.log,\n    error: console.error,\n    warn: console.warn,\n    info: console.info\n};\nfunction sendToConsole(level, ...args) {\n    window.parent.postMessage({\n        type: 'console',\n        level: level,\n        data: args,\n        timestamp: new Date().toISOString()\n    }, '*');\n    originalConsole[level].apply(console, args);\n}\nconsole.log = (...args) => sendToConsole('log', ...args);\nconsole.error = (...args) => sendToConsole('error', ...args);\nconsole.warn = (...args) => sendToConsole('warn', ...args);\nconsole.info = (...args) => sendToConsole('info', ...args);\nwindow.onerror = function(message, source, lineno, colno, error) {\n    sendToConsole('error', error || message);\n    return true;\n};\nwindow.onunhandledrejection = function(event) {\n    sendToConsole('error', event.reason);\n};\n`;

                // Detect if user HTML is a full HTML document
                const isFullHtml = /<html[\s>]|<!doctype html/i.test(html);
                let docContent;
                if (isFullHtml) {
                    // Inject console interceptor into <head> if possible
                    docContent = html.replace(/(<head[^>]*>)/i, `$1\n<script>${consoleInterceptor}<\/script>`);
                } else {
                    // Use template as before
                    docContent = [
                        '<!DOCTYPE html><html><head><meta charset="UTF-8">',
                        '<style>', css, '</style>',
                        '<script>', consoleInterceptor, '<\/script>',
                        '</head><body>', html, '</body>',
                        '<script>', js, '<\/script></html>'
                    ].join('');
                }

                const blob = new Blob([docContent], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                preview.src = url;

                if (document.querySelector('.output-tabs .tab[data-output="preview"]')) {
                    document.querySelector('.output-tabs .tab[data-output="preview"]').click();
                }

                preview.addEventListener('load', function cleanup() {
                    URL.revokeObjectURL(url);
                    preview.removeEventListener('load', cleanup);
                });

                if (document.querySelector('.output-tabs .tab[data-output="preview"]')) {
                    document.querySelector('.output-tabs .tab[data-output="preview"]').click();
                }

                saveState();
            } catch (error) {
                showError(`Error running code: ${error.message}`);
                console.error('Code execution error:', error);
            } finally {
                hideLoading();
            }
        }

        function switchTab(tab) {
            // Hide all editor containers
            document.querySelectorAll('.editor-container').forEach(c => c.style.display = 'none');
            // Show the correct editor container
            if (tab === 'html') {
                document.querySelectorAll('.editor-container')[0].style.display = 'block';
            } else if (tab === 'css') {
                document.querySelectorAll('.editor-container')[1].style.display = 'block';
            } else if (tab === 'js') {
                document.querySelectorAll('.editor-container')[2].style.display = 'block';
            }
            document.querySelectorAll('.editor-tabs .tab').forEach(t => t.classList.remove('active'));
            const tabEl = document.querySelector(`.editor-tabs .tab[data-tab="${tab}"]`);
            if (tabEl) tabEl.classList.add('active');
            // Update line numbers for the active editor
            const lineId = tab === 'html' ? 'line-numbers' : (tab === 'css' ? 'css-line-numbers' : 'js-line-numbers');
            updateLineNumbers(tab + '-editor', document.getElementById(lineId));
            // Focus the editor and move caret to end
            setTimeout(() => {
                const editor = document.getElementById(tab + '-editor');
                editor.focus();
                if (document.createRange && window.getSelection) {
                    const range = document.createRange();
                    range.selectNodeContents(editor);
                    range.collapse(false);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }, 0);
            saveState();
        }

        function switchOutput(output) {
            document.getElementById('preview').classList.remove('active');
            document.getElementById('console').classList.remove('active');
            document.getElementById(output).classList.add('active');
            document.querySelectorAll('.output-tabs .tab').forEach(t => t.classList.remove('active'));
            const tabEl = document.querySelector(`.output-tabs .tab[data-output="${output}"]`);
            if (tabEl) tabEl.classList.add('active');
            saveState();
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        function resetCode() {
            if (confirm('Are you sure you want to reset all code to default?')) {
                const defaultHtml = `<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
</head>
<body>
    <h1>Hello, HTMLRunner!</h1>
    <p>This is a demo page.</p>
    <button onclick="testFunction()">Click me!</button>
</body>
</html>`;

                const defaultCss = `body {
    font-family: Arial, sans-serif;
    margin: 20px;
    line-height: 1.6;
}

button {
    background: #2196F3;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s, transform 0.2s;
}

button:hover {
    background: #1976D2;
    transform: translateY(-2px);
}`;

                setEditorText(document.getElementById('html-editor'), defaultHtml);
                setEditorText(document.getElementById('css-editor'), defaultCss);
                setEditorText(document.getElementById('js-editor'), `function testFunction() {\n    console.log('Button clicked!');\n    console.warn('This is a warning message');\n    console.error('This is an error message');\n    console.info('This is an info message');\n    \n    // Try some calculations\n    const result = Math.random() * 100;\n    console.log('Random number:', result.toFixed(2));\n    \n    // Test object logging\n    const user = {\n        name: 'Alice',\n        age: 25,\n        hobbies: ['coding', 'reading', 'gaming'],\n        details: {\n            email: 'alice@example.com',\n            active: true\n        }\n    };\n    \n    console.log('User object:', user);\n    \n    // Test array logging\n    const numbers = [1, 2, 3, 4, 5];\n    console.log('Numbers array:', numbers);\n    \n    // Test error logging with proper error handling\n    try {\n        // This will throw an error\n        const data = JSON.parse('{"invalid": "json"}'); // Fixed JSON string\n        console.log('Parsed JSON:', data);\n    } catch (error) {\n        console.error('Failed to parse JSON:', error.message);\n    }\n    \n    // Test promise with proper error handling\n    Promise.resolve('This is a resolved promise')\n        .then(result => console.log('Promise resolved:', result))\n        .catch(error => console.error('Promise rejected:', error.message));\n}`);
                runCode();
                saveState();
            }
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            updateThemeIcon();
            updateCodeHighlighting();
        }

        function updateCodeHighlighting() {
            // Remove old highlighting
            document.querySelectorAll('.hljs').forEach(el => {
                el.classList.remove('hljs');
                el.removeAttribute('style');
            });

            // Apply new highlighting
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function updateThemeIcon() {
            const icon = document.querySelector('.theme-toggle i');
            if (isDarkMode) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                document.querySelector('.theme-toggle span').textContent = 'Light Mode';
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                document.querySelector('.theme-toggle span').textContent = 'Dark Mode';
            }
        }

        function updateLineNumbers(editorId, lineNumbersElement) {
            const editor = document.getElementById(editorId);
            if (!editor) return; // Prevent error if editor is not found
            let lines = getEditorText(editor).split('\n');
            if (lines.length === 0 || (lines.length === 1 && lines[0] === '')) lines = [''];
            let html = '';
            for (let i = 1; i <= lines.length; i++) {
                html += `<div>${i}</div>`;
            }
            lineNumbersElement.innerHTML = html;
            lineNumbersElement.scrollTop = editor.scrollTop;
        }

        function initializeEditors() {
            const editors = [
                { id: 'html-editor', lineId: 'line-numbers' },
                { id: 'css-editor', lineId: 'css-line-numbers' },
                { id: 'js-editor', lineId: 'js-line-numbers' }
            ];
            editors.forEach(({ id, lineId }) => {
                const editor = document.getElementById(id);
                const lineNumbers = document.getElementById(lineId);
                const update = () => updateLineNumbers(id, lineNumbers);
                update();
                editor.addEventListener('input', () => {
                    update();
                    saveState();
                });
                editor.addEventListener('paste', () => {
                    setTimeout(update, 0);
                });
                editor.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        
                        // Get current selection
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        
                        // Get the content before cursor in the current line
                        let currentLine = '';
                        let node = range.startContainer;
                        let offset = range.startOffset;
                        
                        if (node.nodeType === Node.TEXT_NODE) {
                            currentLine = node.textContent.substring(0, offset);
                        }
                        
                        // Get indentation of the current line
                        const match = currentLine.match(/^\s+/);
                        const indentation = match ? match[0] : '';
                        
                        // Insert a single newline with indentation
                        document.execCommand('insertText', false, '\n' + indentation);
                        
                        // Update line numbers once
                        update();
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        document.execCommand('insertText', false, '  ');
                    } else if (["Backspace", "Delete"].includes(e.key)) {
                        setTimeout(update, 0);
                    }
                });
                editor.addEventListener('scroll', () => {
                    lineNumbers.scrollTop = editor.scrollTop;
                });
            });
        }
    </script>
</body>

</html>
